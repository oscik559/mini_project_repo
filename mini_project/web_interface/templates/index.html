<!--
This code defines a selection of code that is referenced for documentation purposes.
Please provide the actual code selection to generate a relevant documentation comment.
-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robot Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1e1f26;
            --card-bg: #2c2f36;
            --text-color: #e2e2e2;
            --message-text-color: #181717;
            --accent: #297e8a;
            --send-button: #297e8a;
            --voice-button: #249bb8;
        }

        body {
            /* background-color: var(--bg-color); */
            background-color: #ffffff;
            color: var(--text-color);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .chat-wrapper {
            background-color: var(--card-bg);
            width: 95%;
            max-width: 500px;
            height: 90vh;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            /* border: 2px solid #36b1b1; */
        }

        .chat-header {
            padding: 1em;
            display: flex;
            align-items: center;
            background-color: #222;
            border-bottom: 1px solid #444;
        }

        .chat-header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-right: 1em;
            object-fit: cover;
        }


        .chat-header .status {
            font-size: 0.9em;
            color: var(--accent);
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 1em;
            display: flex;
            flex-direction: column;
            gap: 0.75em;
            background-image: url('/static/chat-bg-robot.png');
            /* background-color: rgb(23, 137, 141); */

            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;

        }


        .chat-message {
            max-width: 80%;
            padding: 0.8em 1em;
            border-radius: 12px;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        .from-user {
            align-self: flex-end;
            background-color: #2a2a2a;
            border: 1px solid #2dc76d;
            color: #e2e2e2;
            border-bottom-right-radius: 0;
        }

        .from-assistant {
            align-self: flex-start;
            background-color: #2a2a2a;
            border: 1px solid #4fc3f7;
            color: #e2e2e2;
            padding: 0.8em 1em;
            border-radius: 16px 16px 16px 0;
            max-width: 80%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }


        .tiny-toolbar {
            width: 100%;
            background: #232323;
            border-bottom: 1px solid #444;
            border-top: 1px solid #444;
            /* border-top-left-radius: 15px; */
            /* border-top-right-radius: 15px; */
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            padding: 0.1em 0.1em 0.1em 0.2em;
            display: flex;
            justify-content: right;   /* <-- Center the content */
            align-items: center;
            min-height: 36px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            font-size: 0.8em;
            gap: 0.7em;
            box-sizing: border-box;
            overflow-x: auto;
        }

        .tiny-toolbar label {
            color: #e2e2e2;
            font-weight: 500;
            margin: 0;
        }

        .tiny-toolbar select {
            background: #181717;
            color: #e2e2e2;
            border: 1px solid #4fc3f7;
            border-radius: 12px;
            padding: 0.2em 1em;
            font-size: 0.8em;
            margin-left: 0.1em;
        }
        .chat-footer {
            padding: 1.5em 1.5em 0.5em 1.5em;
            border-top: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }

        .chat-footer textarea {
            flex: 1;
            resize: none;
            border-radius: 22px;
            border: none;
            font-size: 1em;

            background-color: #dce6e6;
            color: var(--message-text-color);
            font-family: 'Segoe UI','Segoe Print', 'Comic Sans MS', cursive;
            padding: 0.5em 0.5em 0.5em 1em;
        }


        .chat-footer button {
            background-color: var(--send-button);
            border: solid #b9bdbd;
            border-width: 2px;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .chat-footer button:hover {
            background-color: #717374; /* Or tweak the hover accent */
        }

        .chat-body::-webkit-scrollbar {
            width: 6px;
        }

        .chat-body::-webkit-scrollbar-thumb {
            background-color: #e9edf044;
            border-radius: 6px;
        }

        .chat-body::-webkit-scrollbar-track {
            background-color: transparent;
        }

        textarea {
            overflow: hidden;
            max-height: 200px;
            transition: height 0.15s ease;
        }


        #db-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7em;
        }

        #db-table th, #db-table td {
            padding: 0.6em 1em;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        #db-table th {
            background-color: #1e1e1e;
            color: #4fc3f7;
            font-weight: 600;
            font-size: 1.2em;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        #db-table tr:nth-child(even) {
            background-color: #2e2e2e;
        }

        #db-table tr:hover {
            background-color: #3a3a3a;
            transition: 0.2s;
        }

        #db-table {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* Scrollbar styling */
        #db-table::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        #db-table::-webkit-scrollbar-thumb {
            background: #4fc3f7aa;
            border-radius: 4px;
        }

        #db-table::-webkit-scrollbar-track {
            background: transparent;
        }







        .message-wrapper {
            display: flex;
            align-items: flex-end;
            margin-bottom: 0.75em;
            gap: 0.5em;
        }

        .message-wrapper.user {
            justify-content: flex-end;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #666;
            flex-shrink: 0;
        }

        .message-wrapper.user .avatar {
            order: 2;
        }

        .message-wrapper.user .chat-message {
            order: 1;
        }


        .rounded {
            border-radius: 20px;
            padding: 0.5em 0.7em 0.7em 0.4em;
            /*        top  right bottom left  */
            background: #ce375c;
            /* color: #000000; */
            color: #fcfbfb;

            border: 0.2em solid #fffefe;
            font-family: 'Segoe UI','Segoe Print','Nunito', 'Segoe UI', Arial, sans-serif;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            /* margin-right: 0.2em; */
            transition: background 0.2s;
        }

        .rounded:hover {
            background: #797a7a;
        }

        .rounded-btn {
            background-color: var(--accent);
            /* color: #000; */
            color: #fcfbfb;
            font-weight: bold;
            border: 0.2em solid #fdfdfd;
            font-family: 'Segoe Print','Nunito', 'Segoe UI', Arial, sans-serif;
            font-size: 0.7em;

            border-radius: 16px;
            padding: 4px 10px 6px 5px;
            margin-right: 0.3em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .rounded-btn:hover {
            background-color: #2ad49c; /* Or tweak the hover accent */
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="chat-wrapper">
        <div class="chat-header">
            <img src="/static/yumi.png" alt="Yumi avatar">
            <div style="flex-grow: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>Robot Assistant</strong>
                </div>
                <div class="status">üü¢ Online</div>
                <div id="auth-user" style="font-size: 0.75em; color: #aaa;">Authenticated: ...</div>
            </div>
            <img src="/static/liu.png" alt="Logo" style="width: 100px; height: 40px; margin-left: 1em; margin-right: 0em; object-fit: contain;">
        </div>

        <div class="toolbar" style="display: flex; justify-content: space-between;  align-items: center; padding: 0.5em 0.5em;">
            <div>

               <div>
                    <!-- <button onclick="startSession()" class="rounded-btn">üîêSign In</button> -->
                    <button onclick="showSigninWebcamModal()" class="rounded-btn" aria-label="Sign In with webcam">üîêSign In</button>
                    <button onclick="fetchDBView()" class="rounded-btn" aria-label="Show database table">üìäTable</button>
                    <button onclick="simulateTask()" class="rounded-btn" aria-label="Simulate task">üß™Simulate</button>
                    <button onclick="executeTask()" class="rounded-btn" aria-label="Execute task">ü§ñExecute</button>
                    <button onclick="resetMemory()" class="rounded-btn" aria-label="Reset assistant memory">üß†Reset</button>

                </div>
            </div>
            <label style="font-size: 0.9em; font-weight: bold;">
                üîä TTS <input type="checkbox" id="tts-toggle" checked>
            </label>

        </div>

        <!-- Tiny toolbar for voice selection -->
        <div class="tiny-toolbar">
            <label style="font-size: 1em; margin: 0.1;">
                üì¢
                <select id="voice-select" class="rounded"></select>

            </label>
        </div>

        <div id="chat" class="chat-body">
            <!-- Messages go here -->
        </div>

        <div id="db-panel" style="display:none; background:#2a2a2a; color:white; padding:0.8em 0.5em;">
            <div style="margin-bottom: 0.1em;">
                <label for="table-select">üóÇÔ∏è select table:</label>
                <select id="table-select" class="rounded" onchange="loadTable(this.value)">
                    <option value="">choose table...</option>
                    <option value="camera_vision">camera_vision</option>
                    <option value="users">users</option>
                    <option value="operation_sequence">operation_sequence</option>
                    <option value="unified_instructions">unified_instructions</option>
                    <option value="sort_order">sort_order</option>
                    <option value="sequence_library">sequence_library</option>
                </select>
            </div>
            <div id="db-table" style="overflow:auto; max-height:300px;"></div>
        </div>



        <div id="typing-indicator" style="text-align: left; padding: 0 1em; font-style: italic; color: #999;"></div>
        <div class="toolbar" style="display: flex; justify-content: center; align-items: center; gap: 0.3em; padding: 1em 0.5em 0.2em 0.5em;">
            <button onclick="appendQuickReplies()" class="rounded">ü§îReplies</button>
            <button onclick="stopResponse()" class="rounded">‚èπÔ∏èStopTTS</button>
            <button onclick="clearChat()" class="rounded">üßπClear</button>
            <button onclick="showHistory()" class="rounded">üìúHistory</button>
            <label style="font-size: 1em; margin: 0 0;">
                <select id="llm-select" class="rounded" onchange="setLLMModel(this.value)" title="Select a language model">
                    <option value="mistral:latest">üåäMistral</option>

                    <option value="phi4:latest">üßÆPhi-4</option>
                    <option value="gemma3:4b">üíéGemma 3</option>

                    <option value="llama3.3:latest">ü¶ôLlama 3.3</option>
                    <option value="llama3.2:latest">ü¶ôLlama 3.2</option>
                    <option value="llama3.2:1b">ü¶ôLlama 3.1</option>

                    <!-- <option value="deepseek-r1:32b">üîéDeepseek 2</option> -->
                    <!-- <option value="deepseek-r1:1.5b">üî¨Deepseek 1</option> -->

                    <option value="qwen2.5:0.5b">üêßQwen 2.5 </option>
                    <option value="qwen:0.5b">üß©Qwen 0.5</option>

                </select>
            </label>
        </div>
        <div id="quick-replies" class="quick-replies" style="padding: 0.5em 1em; "></div>

        <div class="chat-footer">
            <button onclick="startVoice()" title="voice"><span style="font-size: 1.2em;">üé§</span></button>
            <textarea id="command-input" title="type here" placeholder="Ask anything..." rows="1"></textarea>
            <button onclick="sendCommand()" title="send"><span style="font-size: 1.2em;">üöÄ</span></button>
        </div>
        <footer style="
            text-align: center;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 0em;
            margin-bottom: 0.5em;
            padding: 0.5em;
            background: transparent;
        ">
            ¬© 2025 ¬∑ <a href='https://www.linkedin.com/in/ikechuquoscar/' target='_blank' rel='noopener' style='color: inherit;'>Oscar Ikechukwu</a> ¬∑ Masters Thesis ¬∑ <a href='https://liu.se' target='_blank' rel='noopener' style='color: inherit;'>Link√∂ping University</a>
        </footer>


        <!-- Add this modal to your HTML -->
        <!-- Add this modal to your HTML -->
        <!-- <div id="register-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;" aria-label="User Registration Modal" role="dialog">
            <form id="register-form" style="background:#fff; color:#222; padding:2em; border-radius:10px; min-width:300px;">
                <h3>Register User</h3>
                <input type="text" id="reg-firstname" placeholder="First Name" required style="width:100%;margin-bottom:0.5em;"><br>
                <input type="text" id="reg-lastname" placeholder="Last Name" required style="width:100%;margin-bottom:0.5em;"><br>
                <input type="text" id="reg-liuid" placeholder="LIU ID" required style="width:100%;margin-bottom:0.5em;"><br>
                <input type="email" id="reg-email" placeholder="Email" required style="width:100%;margin-bottom:0.5em;"><br>

                <input type="file" id="reg-face" accept="image/*" capture="user" required style="margin-bottom:0.5em;">
                <button type="button" onclick="showRegisterWebcamModal()" class="rounded-btn" aria-label="Capture face with webcam">Use Webcam</button>
                <input type="file" id="reg-voice" accept="audio/*" capture required style="margin-bottom:0.5em;">
                <button type="button" onclick="showRegisterMicModal()" class="rounded-btn" aria-label="Record voice with microphone">Use Microphone</button>
                <button type="submit" class="rounded-btn" aria-label="Submit registration">Register</button>
                <button type="button" onclick="closeRegisterModal()" class="rounded-btn" aria-label="Cancel registration">Cancel</button>


            </form>
        </div> -->

        <div id="register-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;" aria-label="User Registration Modal" role="dialog">
            <form id="register-form" style="background:#fff; color:#222; padding:2em; border-radius:10px; min-width:300px;">
                <h3>Register User</h3>
                <input type="text" id="reg-firstname" placeholder="First Name" required style="width:100%;margin-bottom:0.5em;"><br>
                <input type="text" id="reg-lastname" placeholder="Last Name" required style="width:100%;margin-bottom:0.5em;"><br>
                <input type="text" id="reg-liuid" placeholder="LIU ID" required style="width:100%;margin-bottom:0.5em;"><br>
                <input type="email" id="reg-email" placeholder="Email" required style="width:100%;margin-bottom:0.5em;"><br>

                <div style="margin-bottom:0.5em;">
                    <input type="file" id="reg-face" accept="image/*" capture="user" required>
                    <button type="button" onclick="showRegisterWebcamModal()" class="rounded-btn" aria-label="Capture face with webcam">Use Webcam</button>
                </div>
                <div style="margin-bottom:0.5em;">
                    <input type="file" id="reg-voice" accept="audio/*" capture required>
                    <button type="button" onclick="showRegisterMicModal()" class="rounded-btn" aria-label="Record voice with microphone">Use Microphone</button>
                </div>
                <button type="submit" class="rounded-btn" aria-label="Submit registration">Register</button>
                <button type="button" onclick="closeRegisterModal()" class="rounded-btn" aria-label="Cancel registration">Cancel</button>
            </form>
        </div>
    </div>

    <script>

        let currentLLMController = null;
        let currentVoiceLLMController = null;

        const textarea = document.getElementById("command-input");

        textarea.addEventListener("input", () => {
            textarea.style.height = "auto"; // Reset height
            if (textarea.scrollHeight > textarea.clientHeight) {
                textarea.style.height = textarea.scrollHeight + "px";
            }

        });

        document.getElementById("command-input").addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendCommand();
            }
        });

        async function startSession() {
            try {
                const res = await fetch("/start-session", { method: "POST" });
                const data = await res.json();

                if (data.authenticated === false) {
                    showRegisterModal();
                    return;
                }

                // Show welcome message
                if (data.username) {
                    appendMessage("assistant", `üëã Welcome, ${data.username}! You are now authenticated.`);
                    updateAuthUser(data.username);
                } else if (data.message) {
                    appendMessage("assistant", data.message);
                }

                // Update model in UI if needed
                if (data.model) {
                    const typingIndicator = document.getElementById("typing-indicator");
                    if (typingIndicator) typingIndicator.innerText = `‚úÖ Using model: ${data.model}`;
                    const llmSelect = document.getElementById("llm-select");
                    if (llmSelect && [...llmSelect.options].some(opt => opt.value === data.model)) {
                        llmSelect.value = data.model;
                    }
                }
            } catch (error) {
                console.error(error);
                showResponse("‚ùå Unable to start session. Please try again.");
            }
        }

        function updateAuthUser(name) {
            document.getElementById("auth-user").innerText = "Authenticated: " + name;
        }

        function showRegisterModal() {
            document.getElementById('register-modal').style.display = 'flex';
        }

        function closeRegisterModal() {
            document.getElementById('register-modal').style.display = 'none';
        }

        document.getElementById('register-form').onsubmit = async function(e) {
            e.preventDefault();
            const data = new FormData();
            data.append('first_name', document.getElementById('reg-firstname').value);
            data.append('last_name', document.getElementById('reg-lastname').value);
            data.append('liu_id', document.getElementById('reg-liuid').value);
            data.append('email', document.getElementById('reg-email').value);
            data.append('face', document.getElementById('reg-face').files[0]);
            data.append('voice', document.getElementById('reg-voice').files[0]);
            const res = await fetch('/register-user', {
                method: 'POST',
                body: data
            });
            const result = await res.json();
            showResponse(result.message);
            closeRegisterModal();
        };

        async function sendCommand() {
            try {
                // Abort any previous request
                if (currentLLMController) currentLLMController.abort();
                currentLLMController = new AbortController();

                const input = document.getElementById("command-input");
                const message = input.value.trim();
                if (!message) {
                    showResponse("‚ùå Command cannot be empty.");
                    return;
                }

                appendMessage("user", message); // <-- Add this line to show user's message

                input.value = "";
                input.style.height = "auto"; // Reset height

                showResponse("ü§ñ Robot is thinking ...");
                const formData = new FormData();
                formData.append("command", message);

                const res = await fetch("/send-command", { method: "POST", body: formData, signal: currentLLMController.signal });
                if (!res.ok) throw new Error("Failed to send command");
                const data = await res.json();
                appendMessage("assistant", data.response || "No response.");
                speakResponse(data.response || "No response.");
                showResponse("");
            } catch (error) {
                if (error.name === "AbortError") {
                    showResponse("‚èπÔ∏è Response stopped.");
                } else {
                    console.error(error);
                    showResponse("‚ùå Unable to process command. Please try again.");
                }
            } finally {
                currentLLMController = null;
            }
        }

        async function sendPredefined(reply) {
            if (currentLLMController) currentLLMController.abort();
            currentLLMController = new AbortController();
            try {
                showResponse("ü§ñ Robot is thinking...");
                const formData = new FormData();
                formData.append("command", reply);
                const res = await fetch("/send-command", { method: "POST", body: formData, signal: currentLLMController.signal });
                const data = await res.json();
                appendMessage("assistant", data.response || "No response.");
                speakResponse(data.response || "No response.");
                showResponse("");
            } catch (error) {
                if (error.name === "AbortError") {
                    showResponse("‚èπÔ∏è Response stopped.");
                } else {
                    console.error(error);
                    showResponse("‚ùå Unable to process command. Please try again.");
                }
            } finally {
                currentLLMController = null;
            }
        }

        async function resetMemory() {
            const res = await fetch("/reset-memory", { method: "POST" });
            const data = await res.json();
            showResponse(data.message);
        }

        function showResponse(text) {
            const typingIndicator = document.getElementById("typing-indicator");
            typingIndicator.innerText = text;
        }

        function fetchDBView() {
            const panel = document.getElementById("db-panel");
            panel.style.display = panel.style.display === "none" ? "block" : "none";
        }

        async function loadTable(tableName) {
            const dbTableDiv = document.getElementById("db-table");
            dbTableDiv.innerHTML = "‚è≥ Loading...";
            try {
                const res = await fetch(`/view-db/${tableName}`);
                if (!res.ok) throw new Error("Failed to fetch table data");
                const data = await res.json();
                if (data.error) {
                    dbTableDiv.innerHTML = `<p>${data.error}</p>`;
                    return;
                }



                const table = document.createElement("table");
                table.style.width = "100%";
                table.style.borderCollapse = "collapse";
                table.style.marginTop = "1em";

                // Header row
                const header = table.insertRow();
                data.columns.forEach(col => {
                    const th = document.createElement("th");
                    th.textContent = col;
                    th.style.borderBottom = "1px solid #4fc3f7";
                    th.style.padding = "0.5em";
                    header.appendChild(th);
                });

                // Data rows
                data.rows.forEach(row => {
                    const tr = table.insertRow();
                    row.forEach(cell => {
                        const td = tr.insertCell();
                        td.textContent = cell;
                        td.style.padding = "0.5em";
                        td.style.borderBottom = "1px solid #444";
                    });
                });

                dbTableDiv.innerHTML = "";
                dbTableDiv.appendChild(table);
            } catch (error) {
                console.error(error);
                dbTableDiv.innerHTML = "<p>‚ùå Error loading table.</p>";
            }
        }

        async function setLLMModel(model) {
            const allowedModels = ["mistral:latest","phi4:latest","gemma3:4b","llama3.3:latest", "llama3.2:latest",  "llama3.2:1b", "qwen2.5:0.5b",  "qwen:0.5b"];

            if (!allowedModels.includes(model)) {
                showResponse("‚ùå Invalid model selected.");
                return;
            }
            try {
                const res = await fetch("/set-model", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ model }),
                });
                if (!res.ok) throw new Error("Failed to set model");
                const data = await res.json();
                showResponse(data.message || `Model set to ${model}`);
            } catch (error) {
                console.error(error);
                showResponse("‚ùå Unable to set model. Please try again.");
            }
        }

        function appendQuickReplies() {
            const container = document.getElementById("quick-replies");
            // Toggle: if already visible, hide; else show
            if (container.innerHTML.trim() !== "") {
                container.innerHTML = '';
                return;
            }

            ["yes", "no", "good bye!", "repeat", "tell me a joke","what can you see?"].forEach(reply => {
                const btn = document.createElement("button");
                btn.textContent = reply;
                btn.style.margin = "0.2em";
                btn.style.padding = "0.3em 0.5em";
                btn.style.borderRadius = "10px";
                btn.style.cursor = "pointer";
                // btn.style.backgroundColor = "#444";
                btn.style.border = "none";
                btn.style.color = "#000";
                btn.onclick = () => {
                    appendMessage("user", reply);
                    showResponse("ü§ñ Robot is thinking ...");
                    sendPredefined(reply);
                    container.innerHTML = '';
                };
                container.appendChild(btn);
            });
        }

        function clearChat() {
            const chat = document.getElementById("chat");
            chat.innerHTML = "";
        }

        function stopResponse() {
            if (currentLLMController) {
                currentLLMController.abort();
                currentLLMController = null;
            }
            if (currentVoiceLLMController) {
                currentVoiceLLMController.abort();
                currentVoiceLLMController = null;
            }
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            showResponse("‚èπÔ∏è Response stopped.");
        }

        function showHistory() {
            alert("History feature coming soon!"); // Replace with your actual history logic
        }

        function appendMessage(sender, text) {
            const chat = document.getElementById("chat");
            const msgWrapper = document.createElement("div");
            msgWrapper.className = `message-wrapper ${sender}`;

            const avatar = document.createElement("div");
            avatar.className = "avatar";
            avatar.innerHTML = `<img src="/static/${sender === 'user' ? 'user-chat-avatar.png' : 'yumi-avatar.png'}" alt="avatar" style="width:100%; height:100%; border-radius:50%;">`;

            const msg = document.createElement("div");
            msg.className = `chat-message ${sender === 'user' ? 'from-user' : 'from-assistant'}`;

            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const textDiv = document.createElement("div");
            textDiv.textContent = text;
            const timeDiv = document.createElement("div");
            timeDiv.style = "font-size: 0.7em; color: #aaa; text-align: right;";
            timeDiv.textContent = time;

            msg.appendChild(textDiv);
            msg.appendChild(timeDiv);

            if (sender === 'user') {
                msgWrapper.appendChild(msg);
                msgWrapper.appendChild(avatar);
            } else {
                msgWrapper.appendChild(avatar);
                msgWrapper.appendChild(msg);
            }

            chat.appendChild(msgWrapper);
            setTimeout(() => {
                chat.scrollTop = chat.scrollHeight;
            }, 10);

            if (sender === 'assistant' && text.trim().endsWith("?")) {
                appendQuickReplies();
            }
        }

        function populateVoiceList() {
            const select = document.getElementById("voice-select");
            if (!select) return;
            const preferredVoiceName = "Microsoft Ryan Online (Natural) - English (United Kingdom)";
            const preferredLang = "en-GB";
            select.innerHTML = "";
            const voices = window.speechSynthesis.getVoices();
            let preferredValue = null;
            voices.forEach((voice) => {
                // Allow all voices, not just English
                const value = `${voice.name}|||${voice.lang}`;
                const option = document.createElement("option");
                option.value = value;
                option.textContent = `${voice.name} (${voice.lang})${voice.default ? " [default]" : ""}`;
                select.appendChild(option);
                if (voice.name === preferredVoiceName && voice.lang === preferredLang) {
                    preferredValue = value;
                }
            });
            // Restore from localStorage, else use preferred, else fallback
            const savedVoice = localStorage.getItem("selectedVoice");
            if (savedVoice && [...select.options].some(opt => opt.value === savedVoice)) {
                select.value = savedVoice;
            } else if (preferredValue !== null) {
                select.value = preferredValue;
            } else if (select.options.length > 0) {
                select.selectedIndex = 0;
            }
        }

        function setPreferredVoice() {
            const select = document.getElementById("voice-select");
            const voices = window.speechSynthesis.getVoices();
            const preferredVoiceName = "Microsoft Ryan Online (Natural) - English (United Kingdom)";
            const preferredLang = "en-GB";
            if (!select || !voices.length) return;
            const preferred = voices.find(v =>
                v.name === preferredVoiceName && v.lang === preferredLang
            );
            if (preferred) {
                select.value = `${preferred.name}|||${preferred.lang}`;
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            populateVoiceList();
            setPreferredVoice();
        });
        window.speechSynthesis.onvoiceschanged = () => {
            populateVoiceList();
            setPreferredVoice();
        };

        function speakResponse(text) {
            if (document.getElementById("tts-toggle")?.checked && 'speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance(text);
                const select = document.getElementById("voice-select");
                const voices = window.speechSynthesis.getVoices();
                let voice = null;
                if (select && voices.length && select.value) {
                    const [name, lang] = select.value.split("|||");
                    voice = voices.find(v => v.name === name && v.lang === lang);
                }
                // Fallback: always try to use preferred if available
                if (!voice) {
                    voice = voices.find(v => v.name === "Microsoft Ryan Online (Natural) - English (United Kingdom)" && v.lang === "en-GB");
                }
                if (voice) {
                    msg.voice = voice;
                    msg.lang = voice.lang;
                } else {
                    msg.lang = "en-GB";
                }
                msg.rate = 1;


                msg.onstart = () => {
                    console.log("TTS started");
                    showResponse("üó£Ô∏è Robot is speaking...");
                };
                msg.onend = () => showResponse("");
                msg.onerror = () => showResponse("");

                window.speechSynthesis.speak(msg);
            }
        }

        // #########################################################################################

        // async function startVoice() {
        //     try {
        //         showResponse("üé§ Listening...");
        //         const res = await fetch("/process-voice", { method: "POST" });
        //         if (!res.ok) throw new Error("Failed to process voice input");
        //         const data = await res.json();

        //         // Show transcription immediately
        //         if (data.transcription) {
        //             appendMessage("user", data.transcription);

        //             // Abort any previous LLM voice fetch
        //             if (currentVoiceLLMController) currentVoiceLLMController.abort();
        //             currentVoiceLLMController = new AbortController();

        //             // Now, fetch the LLM response
        //             showResponse("ü§ñ Thinking...");
        //             const llmRes = await fetch("/llm-response", {
        //                 method: "POST",
        //                 headers: { "Content-Type": "application/json" },
        //                 body: JSON.stringify({ command_text: data.transcription, lang: data.lang || "en" }),
        //                 signal: currentVoiceLLMController.signal
        //             });
        //             if (!llmRes.ok) throw new Error("Failed to get LLM response");
        //             const llmData = await llmRes.json();
        //             appendMessage("assistant", llmData.response || "No response.");
        //             speakResponse(llmData.response || "No response.");
        //             showResponse(""); // Clear the typing indicator here
        //         } else {
        //             showResponse("‚ùå No speech detected.");
        //         }
        //     } catch (error) {
        //         if (error.name === "AbortError") {
        //             showResponse("‚èπÔ∏è Response stopped.");
        //         } else {
        //             console.error(error);
        //             showResponse("‚ùå Unable to process voice input. Please try again.");
        //         }
        //     } finally {
        //         currentVoiceLLMController = null;
        //     }
        // }
        // #########################################################################################

        // let mediaRecorder;
        // let audioChunks = [];

        // async function startVoice() {
        //     try {
        //         showResponse("üé§ Listening...");
        //         // Request microphone access
        //         const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        //         mediaRecorder = new MediaRecorder(stream);

        //         audioChunks = [];
        //         mediaRecorder.ondataavailable = event => {
        //             if (event.data.size > 0) audioChunks.push(event.data);
        //         };

        //         mediaRecorder.onstop = async () => {
        //             const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        //             const formData = new FormData();
        //             formData.append('audio', audioBlob, 'voice_input.webm');

        //             const res = await fetch("/process-voice", { method: "POST", body: formData });
        //             if (!res.ok) throw new Error("Failed to process voice input");
        //             const data = await res.json();

        //             if (data.transcription) {
        //                 appendMessage("user", data.transcription);
        //                 if (currentVoiceLLMController) currentVoiceLLMController.abort();
        //                 currentVoiceLLMController = new AbortController();
        //                 showResponse("ü§ñ Thinking...");
        //                 const llmRes = await fetch("/llm-response", {
        //                     method: "POST",
        //                     headers: { "Content-Type": "application/json" },
        //                     body: JSON.stringify({ command_text: data.transcription, lang: data.lang || "en" }),
        //                     signal: currentVoiceLLMController.signal
        //                 });
        //                 if (!llmRes.ok) throw new Error("Failed to get LLM response");
        //                 const llmData = await llmRes.json();
        //                 appendMessage("assistant", llmData.response || "No response.");
        //                 speakResponse(llmData.response || "No response.");
        //                 showResponse("");
        //             } else {
        //                 showResponse("‚ùå No speech detected.");
        //             }
        //         };

        //         mediaRecorder.start();

        //         // Automatically stop after 6 seconds (or add a stop button)
        //         setTimeout(() => {
        //             if (mediaRecorder.state !== "inactive") mediaRecorder.stop();
        //         }, 6000);

        //     } catch (error) {
        //         showResponse("‚ùå Unable to access microphone or process voice input.");
        //         console.error(error);
        //     }
        // }

        let mediaRecorder;
        let audioChunks = [];
        let silenceTimeout;
        let audioContext, analyser, source, dataArray;
        let calibratedSilenceRMS = null;
        let vadActive = false;
        let speechDetected = false;

        async function startVoice() {
            try {
                showResponse("üé§ Calibrating ambient noise...");
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                speechDetected = false;

                // Setup Web Audio API for VAD and calibration
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                source.connect(analyser);
                analyser.fftSize = 2048;
                dataArray = new Uint8Array(analyser.fftSize);

                // 1. Ambient noise calibration (1 second)
                calibratedSilenceRMS = await calibrateAmbientNoise(analyser, dataArray, 1000);
                const silenceThreshold = calibratedSilenceRMS + 2.5; // tweak margin as needed

                showResponse("üé§ Listening...");

                // Start silence timer immediately after calibration
                silenceTimeout = setTimeout(() => {
                    if (!speechDetected && mediaRecorder.state !== "inactive") {
                        mediaRecorder.stop();
                        showResponse("‚ùå No speech detected (timeout).");
                    }
                }, 2000); // 3 seconds of silence after calibration

                function checkVAD() {
                    analyser.getByteTimeDomainData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        let val = dataArray[i] - 128;
                        sum += val * val;
                    }
                    let rms = Math.sqrt(sum / dataArray.length);

                    // Voice Activity Detection
                    if (rms > silenceThreshold) {
                        if (!speechDetected) {
                            speechDetected = true;
                            if (silenceTimeout) {
                                clearTimeout(silenceTimeout);
                                silenceTimeout = null;
                            }
                        }
                        vadActive = true;
                        if (silenceTimeout) {
                            clearTimeout(silenceTimeout);
                            silenceTimeout = null;
                        }
                    } else {
                        if (vadActive && !silenceTimeout) {
                            // Start silence timer after speech
                            silenceTimeout = setTimeout(() => {
                                if (mediaRecorder.state !== "inactive") {
                                    mediaRecorder.stop();
                                }
                            }, 2000); // 3 seconds of silence after speech
                        }
                    }
                    if (mediaRecorder.state === "recording") {
                        requestAnimationFrame(checkVAD);
                    }
                }

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    if (audioContext) audioContext.close();
                    if (silenceTimeout) clearTimeout(silenceTimeout);

                    // Only process if speech was detected
                    if (!speechDetected) {
                        showResponse("‚ùå No speech detected.");
                        return;
                    }

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'voice_input.webm');

                    const res = await fetch("/process-voice", { method: "POST", body: formData });
                    if (!res.ok) throw new Error("Failed to process voice input");
                    const data = await res.json();

                    if (data.transcription) {
                        appendMessage("user", data.transcription);
                        if (currentVoiceLLMController) currentVoiceLLMController.abort();
                        currentVoiceLLMController = new AbortController();
                        showResponse("ü§ñ Thinking...");
                        const llmRes = await fetch("/llm-response", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ command_text: data.transcription, lang: data.lang || "en" }),
                            signal: currentVoiceLLMController.signal
                        });
                        if (!llmRes.ok) throw new Error("Failed to get LLM response");
                        const llmData = await llmRes.json();
                        appendMessage("assistant", llmData.response || "No response.");
                        speakResponse(llmData.response || "No response.");
                        showResponse("");
                    } else {
                        showResponse("‚ùå No speech detected.");
                    }
                };

                mediaRecorder.start();
                vadActive = false;
                checkVAD(); // Start VAD loop

            } catch (error) {
                showResponse("‚ùå Unable to access microphone or process voice input.");
                console.error(error);
            }
        }


        // Helper: Calibrate ambient noise RMS for given ms
        function calibrateAmbientNoise(analyser, dataArray, ms = 1000) {
            return new Promise(resolve => {
                let samples = [];
                let start = performance.now();
                function sample() {
                    analyser.getByteTimeDomainData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        let val = dataArray[i] - 128;
                        sum += val * val;
                    }
                    let rms = Math.sqrt(sum / dataArray.length);
                    samples.push(rms);
                    if (performance.now() - start < ms) {
                        requestAnimationFrame(sample);
                    } else {
                        // Use median to avoid spikes
                        samples.sort((a, b) => a - b);
                        let median = samples[Math.floor(samples.length / 2)];
                        resolve(median);
                    }
                }
                sample();
            });
        }

        document.getElementById("tts-toggle").addEventListener("change", function (e) {
            if (!e.target.checked && 'speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        });
        document.getElementById("voice-select").addEventListener("change", function (e) {
            localStorage.setItem("selectedVoice", e.target.value);
        });

        let signinWebcamStream = null;

        function showSigninWebcamModal() {
            document.getElementById('signin-webcam-modal').style.display = 'flex';
            const video = document.getElementById('signin-webcam-video');
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    signinWebcamStream = stream;
                    video.srcObject = stream;
                })
                .catch(err => {
                    showResponse("‚ùå Unable to access webcam.");
                    closeSigninWebcamModal();
                });
        }

        function closeSigninWebcamModal() {
            document.getElementById('signin-webcam-modal').style.display = 'none';
            const video = document.getElementById('signin-webcam-video');
            if (signinWebcamStream) {
                signinWebcamStream.getTracks().forEach(track => track.stop());
                signinWebcamStream = null;
            }
            video.srcObject = null;
        }

        function captureSigninPhoto() {
            const video = document.getElementById('signin-webcam-video');
            const canvas = document.getElementById('signin-webcam-canvas');
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(async blob => {
                closeSigninWebcamModal();
                showResponse("‚è≥ Authenticating...");
                const formData = new FormData();
                formData.append('face', blob, 'signin_face.png');
                try {
                    const res = await fetch('/authenticate-user', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();
                    if (result.success) {
                            const welcomeMsg = `Welcome, ${result.first_name}!`;
                            appendMessage("assistant", welcomeMsg);
                            updateAuthUser(result.first_name);
                            speakResponse(welcomeMsg);
                    } else if (result.register) {
                        showRegisterModal();
                        showResponse("Face not recognized. Please register.");
                    } else {
                        appendMessage("assistant", result.message || "‚ùå Authentication failed.");
                        showResponse(result.message || "");
                    }
                } catch (err) {
                    showResponse("‚ùå Authentication error.");
                } finally {
                    showResponse(""); // <-- This clears the "Authenticating..." message
                }
            }, "image/png");
        }

        let registerWebcamStream = null;

        function showRegisterWebcamModal() {
            document.getElementById('register-webcam-modal').style.display = 'flex';
            const video = document.getElementById('register-webcam-video');
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    registerWebcamStream = stream;
                    video.srcObject = stream;
                })
                .catch(err => {
                    showResponse("‚ùå Unable to access webcam.");
                    closeRegisterWebcamModal();
                });
        }

        function closeRegisterWebcamModal() {
            document.getElementById('register-webcam-modal').style.display = 'none';
            const video = document.getElementById('register-webcam-video');
            if (registerWebcamStream) {
                registerWebcamStream.getTracks().forEach(track => track.stop());
                registerWebcamStream = null;
            }
            video.srcObject = null;
        }

        function captureRegisterPhoto() {
            const video = document.getElementById('register-webcam-video');
            const canvas = document.getElementById('register-webcam-canvas');
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => {
                // Set the captured blob as the file input for registration
                const file = new File([blob], "register_face.png", { type: "image/png" });
                document.getElementById('reg-face').files = createFileList(file);
                closeRegisterWebcamModal();
                showResponse("‚úÖ Face captured from webcam. Complete the registration form.");
            }, "image/png");
        }

        // Helper to create a FileList from a single File
        function createFileList(file) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            return dataTransfer.files;
        }




        // #===========================================================
        // # Microphone Registration
        let registerMediaRecorder;
        let registerAudioChunks = [];

        function showRegisterMicModal() {
            document.getElementById('register-mic-modal').style.display = 'flex';
            document.getElementById('mic-status').innerText = 'Click "Start" and speak clearly.';
            document.getElementById('register-voice-preview').style.display = 'none';
        }

        function closeRegisterMicModal() {
            document.getElementById('register-mic-modal').style.display = 'none';
            if (registerMediaRecorder && registerMediaRecorder.state !== "inactive") {
                registerMediaRecorder.stop();
            }
        }

        async function startRegisterVoice() {
            registerAudioChunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            registerMediaRecorder = new MediaRecorder(stream);
            registerMediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) registerAudioChunks.push(e.data);
            };
            registerMediaRecorder.onstop = () => {
                const audioBlob = new Blob(registerAudioChunks, { type: 'audio/webm' });
                const file = new File([audioBlob], "register_voice.webm", { type: "audio/webm" });
                document.getElementById('reg-voice').files = createFileList(file);
                // Show preview
                const audioURL = URL.createObjectURL(audioBlob);
                const preview = document.getElementById('register-voice-preview');
                preview.src = audioURL;
                preview.style.display = 'block';
                document.getElementById('mic-status').innerText = 'Recording complete. You can close this window.';
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
            };
            registerMediaRecorder.start();
            document.getElementById('mic-status').innerText = 'Recording... Click "Stop" when done.';
        }

        function stopRegisterVoice() {
            if (registerMediaRecorder && registerMediaRecorder.state !== "inactive") {
                registerMediaRecorder.stop();
            }
        }

        // Helper to create a FileList from a single File
        function createFileList(file) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            return dataTransfer.files;
        }
        // #===========================================================

    </script>

    <!-- Webcam Modal for Sign In -->
    <div id="signin-webcam-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:2000;" aria-label="Webcam Sign In Modal" role="dialog">
        <div style="background:#494848; padding:1em; border-radius:10px; display:flex; flex-direction:column; align-items:center;">
            <video id="signin-webcam-video" autoplay playsinline width="320" height="240" style="border-radius:8px; background:#222;" aria-label="Webcam video preview"></video>
            <canvas id="signin-webcam-canvas" width="320" height="240" style="display:none;"></canvas>
            <div style="margin-top:0.01em;">
                <button onclick="captureSigninPhoto()" class="rounded-btn" aria-label="Capture photo for sign in">üì∏ Capture</button>
                <button onclick="closeSigninWebcamModal()" class="rounded-btn" aria-label="Cancel sign in">‚ùå Cancel</button>
            </div>
        </div>
    </div>
    <!-- Webcam Modal for Register  -->
    <div id="register-webcam-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:2000;" aria-label="Webcam Register Modal" role="dialog">
      <div style="background:#494848; padding:2em; border-radius:10px; display:flex; flex-direction:column; align-items:center;">
        <video id="register-webcam-video" autoplay playsinline width="320" height="240" style="border-radius:8px; background:#222;" aria-label="Webcam video preview"></video>
        <canvas id="register-webcam-canvas" width="320" height="240" style="display:none;"></canvas>
        <div style="margin-top:1em;">
          <button onclick="captureRegisterPhoto()" class="rounded-btn" aria-label="Capture photo for registration">üì∏ Capture</button>
          <button onclick="closeRegisterWebcamModal()" class="rounded-btn" aria-label="Cancel registration webcam">Cancel</button>
        </div>
      </div>
    </div>
    <!-- Microphone Modal for Voice Recording -->
    <div id="register-mic-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:2000;" aria-label="Microphone Register Modal" role="dialog">
      <div style="background:#494848; padding:2em; border-radius:10px; display:flex; flex-direction:column; align-items:center;">
        <div id="mic-status" style="color:white; margin-bottom:1em;">Click "Start" and speak clearly.</div>
        <button onclick="startRegisterVoice()" class="rounded-btn" aria-label="Start recording">üé§ Start</button>
        <button onclick="stopRegisterVoice()" class="rounded-btn" aria-label="Stop recording">‚èπÔ∏è Stop</button>
        <button onclick="closeRegisterMicModal()" class="rounded-btn" aria-label="Cancel voice recording">Cancel</button>
        <audio id="register-voice-preview" controls style="margin-top:1em; display:none;"></audio>
      </div>
    </div>
</body>
</html>
