---
config:
  look: classic
  theme: mc
  layout: fixed
  themeVariables:
    primaryColor: '#000'
    primaryTextColor: '#fff'
    primaryBorderColor: '#7C0000'
    lineColor: '#000000'
    secondaryColor: '#000000'
    tertiaryColor: '#0000'
---
flowchart TD
    A["Start Application (Task Manager GUI)"] --> B["Authenticate User"]
    B --> C["Face Authentication"]
    C L_C_F_0@o-- Face recognized --o F["User Authenticated (liu_id stored)"]
    C -- Face not recognized --> D["Voice Registration"]
    D --> E["Retry Face Authentication"]
    E --> F
    F --> G["Start Execution"]
    G --> H["Generate Session ID"]
    H --> I["Start Voice Capture Thread"] & J["Start Gesture Capture Thread"]
    I --> K["VoiceProcessor.capture_voice()"]
    J --> L["GestureDetector.process_video_stream()"]
    K --> M["Store Voice & Gesture Instructions in DB"]
    L --> M
    M --> N["Synchronizer: Merge Instructions<br>and Run LLM Unification"]
    N --> O["Unified Command Generated<br>and Stored in DB"]
    O --> P["CommandProcessor retrieves Unified Command"]
    P --> Q["Display Unified Command to User"]
    Q --> R{"User Confirmation?<br>(YES/NO)"}
    R -- YES --> S["If YES: Process Command<br>via CommandProcessor.process_command()"]
    R -- NO --> U["If NO: Recapture Input"]
    S --> T["Insert Operation Sequence into DB"]
    T --> V["Execution Complete<br>or Loop for Next Command"]
    U --> I
    A@{ shape: rounded}
     A:::nodeStyle
     B:::processStyle
     C:::processStyle
     F:::nodeStyle
     D:::processStyle
     E:::processStyle
     G:::processStyle
     H:::processStyle
     I:::nodeStyle
     J:::nodeStyle
     K:::processStyle
     L:::processStyle
     M:::processStyle
     N:::processStyle
     O:::nodeStyle
     P:::processStyle
     Q:::nodeStyle
     R:::decisionStyle
     S:::processStyle
     U:::processStyle
     T:::processStyle
     V:::nodeStyle
    classDef nodeStyle fill:#00C853, stroke:#faf7f7, stroke-width:2px, font-weight:bold, color:#000000
    classDef decisionStyle fill:#D50000, stroke:#faf7f7, stroke-width:2px, font-weight:bold, color:#000000
    classDef processStyle fill:#FF6D00, stroke:#faf7f7, stroke-width:4px, font-weight:bold, color:#000000, stroke-dasharray: 0
    style A fill:#FFD600
    linkStyle 2 stroke:#D50000,fill:none
    linkStyle 18 stroke:#000000,fill:none
    L_C_F_0@{ animation: slow }
